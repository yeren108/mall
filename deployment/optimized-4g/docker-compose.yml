version: '3.8'

# Mall 电商系统 - 2核4G 全功能优化部署
# 内存优化配置，总计约 3.75GB

services:
  # ==================== 应用服务 ====================

  mall-admin:
    image: ${REGISTRY:-registry.cn-shanghai.aliyuncs.com/mall}/mall-admin:${VERSION:-latest}
    container_name: mall-admin
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-Xms350m -Xmx350m -XX:+UseG1GC -XX:MaxGCPauseMillis=200
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=mall
      - DB_USER=${DB_USER:-mall_app}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - OSS_ENDPOINT=${OSS_ENDPOINT}
      - OSS_ACCESS_KEY_ID=${OSS_ACCESS_KEY_ID}
      - OSS_ACCESS_KEY_SECRET=${OSS_ACCESS_KEY_SECRET}
      - OSS_BUCKET_NAME=${OSS_BUCKET_NAME}
    volumes:
      - ${DATA_DIR:-/opt/mall}/logs/mall-admin:/var/logs
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - mall-network
    deploy:
      resources:
        limits:
          memory: 400M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  mall-portal:
    image: ${REGISTRY:-registry.cn-shanghai.aliyuncs.com/mall}/mall-portal:${VERSION:-latest}
    container_name: mall-portal
    ports:
      - "8085:8085"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-Xms500m -Xmx500m -XX:+UseG1GC -XX:MaxGCPauseMillis=200
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=mall
      - DB_USER=${DB_USER:-mall_app}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MONGO_HOST=mongo
      - MONGO_PORT=27017
      - MONGO_DATABASE=mall-port
      - MONGO_USER=${MONGO_USER}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MQ_HOST=rabbitmq
      - MQ_PORT=5672
      - MQ_VHOST=/mall
      - MQ_USER=${MQ_USER}
      - MQ_PASSWORD=${MQ_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - ${DATA_DIR:-/opt/mall}/logs/mall-portal:/var/logs
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
      mongo:
        condition: service_started
      rabbitmq:
        condition: service_started
    networks:
      - mall-network
    deploy:
      resources:
        limits:
          memory: 600M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  mall-search:
    image: ${REGISTRY:-registry.cn-shanghai.aliyuncs.com/mall}/mall-search:${VERSION:-latest}
    container_name: mall-search
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-Xms200m -Xmx200m -XX:+UseG1GC
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=mall
      - DB_USER=${DB_USER:-mall_app}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - ES_HOST=elasticsearch
      - ES_PORT=9200
    volumes:
      - ${DATA_DIR:-/opt/mall}/logs/mall-search:/var/logs
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
      elasticsearch:
        condition: service_healthy
    networks:
      - mall-network
    deploy:
      resources:
        limits:
          memory: 300M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==================== 数据库服务 ====================

  mysql:
    image: mysql:5.7
    container_name: mall-mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=mall
      - MYSQL_USER=${DB_USER:-mall_app}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - TZ=Asia/Shanghai
    volumes:
      - ${DATA_DIR:-/opt/mall}/data/mysql:/var/lib/mysql
      - ./config/mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_general_ci
      - --default-time-zone=+08:00
      - --max_connections=100
      - --innodb_buffer_pool_size=500M
    restart: unless-stopped
    networks:
      - mall-network
    deploy:
      resources:
        limits:
          memory: 800M
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7-alpine
    container_name: mall-redis
    ports:
      - "6379:6379"
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 150mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    volumes:
      - ${DATA_DIR:-/opt/mall}/data/redis:/data
    restart: unless-stopped
    networks:
      - mall-network
    deploy:
      resources:
        limits:
          memory: 200M
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongo:
    image: mongo:4.4
    container_name: mall-mongo
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=mall-port
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD}
    volumes:
      - ${DATA_DIR:-/opt/mall}/data/mongo:/data/db
      - ./config/mongo/mongod.conf:/etc/mongod.conf:ro
    command: mongod --config /etc/mongod.conf
    restart: unless-stopped
    networks:
      - mall-network
    deploy:
      resources:
        limits:
          memory: 400M
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==================== 中间件服务 ====================

  rabbitmq:
    image: rabbitmq:3.11-management-alpine
    container_name: mall-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=${MQ_USER}
      - RABBITMQ_DEFAULT_PASS=${MQ_PASSWORD}
      - RABBITMQ_DEFAULT_VHOST=/mall
    volumes:
      - ${DATA_DIR:-/opt/mall}/data/rabbitmq:/var/lib/rabbitmq
    restart: unless-stopped
    networks:
      - mall-network
    deploy:
      resources:
        limits:
          memory: 300M
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  elasticsearch:
    image: elasticsearch:7.17.3
    container_name: mall-elasticsearch
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms800m -Xmx800m -Xmn256m
      - cluster.name=mall-cluster
      - node.name=mall-node-1
      - bootstrap.memory_lock=false
      - indices.memory.index_buffer_size=50mb
      - indices.memory.min_index_buffer_size=10mb
    volumes:
      - ${DATA_DIR:-/opt/mall}/data/elasticsearch:/usr/share/elasticsearch/data
      - ./config/elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
    restart: unless-stopped
    networks:
      - mall-network
    deploy:
      resources:
        limits:
          memory: 900M
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\\|yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

networks:
  mall-network:
    driver: bridge
